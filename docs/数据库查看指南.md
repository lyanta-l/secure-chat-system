# 数据库查看指南

## 📋 概述

SecureChat 系统使用 **SQLite3** 数据库来存储用户信息和加密消息。数据库文件位于：
```
/home/lyanta/secureChat/secure-chat-system/server/database.db
```

## 🔍 查看数据库的方法

### 方法 1：使用自定义查看工具（推荐）

我们提供了一个专门的 Node.js 工具来查看数据库内容。

#### 基本使用

```bash
# 进入 server 目录
cd /home/lyanta/secureChat/secure-chat-system/server

# 显示统计信息、用户列表和最近20条消息
node view-messages.js
```

#### 高级用法

```bash
# 1. 查看所有消息（默认100条）
node view-messages.js --all

# 2. 查看指定数量的消息
node view-messages.js --all 50

# 3. 只查看用户列表
node view-messages.js --users

# 4. 只查看统计信息
node view-messages.js --stats

# 5. 查看两个用户之间的对话
node view-messages.js --chat <用户ID1> <用户ID2>
# 示例：查看用户1和用户2的对话
node view-messages.js --chat 1 2

# 6. 查看单条消息的完整内容
node view-messages.js --message <消息ID>
# 示例：查看消息#5的完整内容
node view-messages.js --message 5

# 7. 显示帮助信息
node view-messages.js --help
```

### 方法 2：使用 SQLite3 命令行工具

如果你想使用原生的 SQLite 工具，需要先安装：

```bash
# 安装 sqlite3 命令行工具
sudo apt install sqlite3

# 进入数据库
cd /home/lyanta/secureChat/secure-chat-system/server
sqlite3 database.db
```

常用 SQL 查询：

```sql
-- 查看所有表
.tables

-- 查看表结构
.schema users
.schema messages
.schema sessions

-- 查看所有用户
SELECT * FROM users;

-- 查看所有消息
SELECT 
  m.id,
  u1.username as 发送者,
  u2.username as 接收者,
  m.encrypted_content as 加密内容,
  m.created_at as 时间
FROM messages m
JOIN users u1 ON m.from_user_id = u1.id
JOIN users u2 ON m.to_user_id = u2.id
ORDER BY m.created_at DESC;

-- 查看两个用户之间的对话
SELECT 
  u1.username as 发送者,
  u2.username as 接收者,
  m.encrypted_content,
  m.created_at
FROM messages m
JOIN users u1 ON m.from_user_id = u1.id
JOIN users u2 ON m.to_user_id = u2.id
WHERE (m.from_user_id = 1 AND m.to_user_id = 2) 
   OR (m.from_user_id = 2 AND m.to_user_id = 1)
ORDER BY m.created_at ASC;

-- 退出
.quit
```

### 方法 3：使用图形化工具

推荐使用 **DB Browser for SQLite**：

```bash
# 安装
sudo apt install sqlitebrowser

# 打开数据库
sqlitebrowser /home/lyanta/secureChat/secure-chat-system/server/database.db
```

或者使用在线工具：
- SQLite Viewer (https://sqliteviewer.app/)
- SQLite Online (https://sqliteonline.com/)

## 📊 数据库结构

### users 表（用户表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 用户ID（主键） |
| username | TEXT | 用户名（唯一） |
| password_hash | TEXT | 密码哈希值 |
| public_key | TEXT | RSA公钥 |
| created_at | DATETIME | 创建时间 |

### messages 表（消息表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 消息ID（主键） |
| from_user_id | INTEGER | 发送者ID |
| to_user_id | INTEGER | 接收者ID |
| encrypted_content | TEXT | 加密消息内容 |
| iv | TEXT | AES加密的初始化向量 |
| created_at | DATETIME | 发送时间 |

### sessions 表（会话表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| token | TEXT | 会话令牌（主键） |
| user_id | INTEGER | 用户ID |
| created_at | DATETIME | 创建时间 |
| expires_at | DATETIME | 过期时间 |

## 🔐 关于加密

**重要提示**：数据库中存储的消息内容是**加密的**！

- 早期消息（没有IV的）可能是明文测试消息
- 后期消息都经过 **AES-256-GCM** 加密
- 每条消息都有对应的 **IV（初始化向量）**
- 解密需要相应的 **AES 密钥**，密钥存储在用户浏览器的 localStorage 中
- 服务器端**无法解密**消息内容（端到端加密）

## 💡 实用示例

### 示例1：查看当前有多少用户和消息
```bash
node view-messages.js --stats
```

### 示例2：查看最近50条消息
```bash
node view-messages.js --all 50
```

### 示例3：查看 google1 和 google2 的聊天记录
```bash
# 首先查看用户ID
node view-messages.js --users

# 假设 google1 的ID是7，google2 的ID是8
node view-messages.js --chat 7 8
```

### 示例4：查看某条消息的完整加密内容
```bash
node view-messages.js --message 27
```

## 🛠️ 故障排除

### 问题1：找不到数据库文件
**解决方案**：确保服务器至少启动过一次，数据库文件会自动创建。

### 问题2：提示"数据库被锁定"
**解决方案**：关闭正在运行的服务器，或使用只读模式查看。

### 问题3：看不到消息内容
**解决方案**：消息是加密的，你看到的是密文。只有在浏览器客户端才能看到解密后的明文。

## 📝 快速参考

创建别名方便使用：

```bash
# 添加到 ~/.bashrc
alias view-chat='cd /home/lyanta/secureChat/secure-chat-system/server && node view-messages.js'

# 重新加载配置
source ~/.bashrc

# 然后就可以直接使用
view-chat
view-chat --users
view-chat --chat 1 2
```

## 🔗 相关文档

- [项目架构说明](./架构整理说明.md)
- [使用指南](./USAGE_GUIDE.md)
- [项目计划](./PROJECT_PLAN.md)

