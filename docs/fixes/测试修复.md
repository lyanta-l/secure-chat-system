# 测试密钥初始化修复

## 快速测试步骤

### 1. 启动服务

**终端 1 - 启动服务器：**
```bash
cd /home/lyanta/secureChat/secure-chat-system/server
node server.js
```

**终端 2 - 启动客户端：**
```bash
cd /home/lyanta/secureChat/secure-chat-system/client
npm start
```

### 2. 测试新用户聊天（修复的核心场景）

#### 步骤 A：注册第一个用户
1. 浏览器自动打开 `http://localhost:3000`
2. 点击"没有账号?点击注册"
3. 注册账号：
   - 用户名：`google1`
   - 密码：`123456`
4. 注册成功后点击登录
5. 登录后会看到用户列表页面
6. **保持这个窗口打开**

#### 步骤 B：注册第二个用户
1. 打开**隐私/无痕窗口**（Ctrl+Shift+N 或 Ctrl+Shift+P）
2. 访问 `http://localhost:3000`
3. 点击"没有账号?点击注册"
4. 注册账号：
   - 用户名：`google2`
   - 密码：`123456`
5. 注册成功后点击登录
6. 登录后会看到用户列表，应该能看到 `google1` 在线（绿点）

#### 步骤 C：开始聊天测试
1. 在 `google2` 的窗口，点击 `google1` 进入聊天
2. 观察状态变化：
   - ❌ 旧版本：立即显示"连接中..."，然后显示错误
   - ✅ 新版本：`连接中...` → `🔄 密钥初始化中...` → `🔐 安全连接`
3. 等待状态变为 `🔐 安全连接`（通常1-2秒）
4. 输入消息："你好，我是 google2"
5. 点击发送

#### 步骤 D：验证接收
1. 切换到 `google1` 的窗口
2. 应该能看到新消息提示（用户列表中 google2 有未读标识）
3. 点击 `google2` 进入聊天
4. 应该能看到 google2 发送的消息："你好，我是 google2"
5. 回复消息："你好，我是 google1"

#### 步骤 E：双向通信测试
1. 在两个窗口之间来回发送多条消息
2. 验证：
   - ✅ 所有消息都能成功发送
   - ✅ 所有消息都能正确接收和解密
   - ✅ 没有"加密密钥未初始化"的错误
   - ✅ 没有"[消息解密失败]"的提示

### 3. 检查控制台日志

**google1 窗口（F12 打开控制台）：**
```
全局WebSocket已连接
已接收并保存AES密钥
已加载AES密钥
```

**google2 窗口（F12 打开控制台）：**
```
全局WebSocket已连接
已生成新的AES密钥
已发送加密的AES密钥
```

### 4. 测试刷新后的会话

1. 在 `google1` 窗口刷新页面（F5）
2. 重新登录
3. 进入与 `google2` 的聊天
4. 应该能看到：
   - ✅ 历史消息正确显示
   - ✅ 状态快速变为 `🔐 安全连接`（因为密钥已保存）
   - ✅ 可以继续发送新消息

## 预期结果对比

### ❌ 修复前的问题
- 点击发送消息后弹出：**"加密密钥未初始化，请稍后重试"**
- 控制台可能显示 WebSocket 错误
- 无法发送任何消息
- 需要多次刷新页面才可能成功

### ✅ 修复后的表现
- 状态清晰显示：`连接中...` → `🔄 密钥初始化中...` → `🔐 安全连接`
- 密钥初始化完成后（1-2秒），发送按钮自动启用
- 消息可以正常加密发送
- 消息可以正常解密接收
- 控制台日志清晰显示密钥交换过程

## 可能的问题排查

### 问题 1：仍然显示"加密密钥未初始化"
**检查项：**
- [ ] 确认已经应用了所有修复文件
- [ ] 确认客户端已重启（`npm start`）
- [ ] 清除浏览器缓存和 localStorage
- [ ] 检查控制台是否有其他错误

### 问题 2：状态一直显示"密钥初始化中..."
**检查项：**
- [ ] 确认服务器正常运行
- [ ] 检查网络连接（WebSocket 端口 3001）
- [ ] 查看控制台是否有密钥交换失败的错误
- [ ] 确认对方用户在线

### 问题 3：消息显示"[消息解密失败]"
**检查项：**
- [ ] 可能是历史消息（旧版本未加密）
- [ ] 清除 localStorage 重新登录
- [ ] 确认密钥交换成功完成

## 成功标志

当你看到以下现象时，说明修复成功：

1. ✅ 两个新注册的用户可以立即开始聊天
2. ✅ 状态显示 "🔐 安全连接"
3. ✅ 消息正常加密发送和解密接收
4. ✅ 控制台日志显示完整的密钥交换过程
5. ✅ 没有任何错误提示
6. ✅ 刷新后历史消息正确显示

## 技术验证

### 验证 WebSocket 连接数
在服务器控制台应该只看到**每个用户一个连接**：
```
用户 1 已连接
用户 2 已连接
```

**不应该看到**：
```
用户 1 已连接
用户 1 已连接  ← 重复连接（问题）
```

### 验证密钥存储
打开浏览器控制台 → Application → Local Storage → http://localhost:3000

应该看到：
- `token`: JWT 令牌
- `userId`: 用户 ID
- `username`: 用户名
- `privateKey_google1`: 私钥（仅注册时）
- `aesKey_1_2`: AES 密钥（与用户2的聊天）

### 验证消息加密
在服务器控制台，当发送消息时应该看到：
```
消息: 从 1 到 2
```

在数据库中存储的消息应该是**加密的 Base64 字符串**，而不是明文。

