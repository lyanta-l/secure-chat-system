# 密钥初始化问题修复 - 文件清单

## 修改的文件

### 新增文件

1. **`/home/lyanta/secureChat/secure-chat-system/client/src/contexts/WebSocketContext.jsx`**
   - 创建全局 WebSocket Context
   - 提供单一的 WebSocket 连接
   - 实现消息处理器注册机制
   - 包含自动重连逻辑

### 修改的文件

2. **`/home/lyanta/secureChat/secure-chat-system/client/src/App.js`**
   - 导入 `WebSocketProvider`
   - 用 `WebSocketProvider` 包裹所有需要 WebSocket 的组件
   - 确保应用只有一个 WebSocket 连接

3. **`/home/lyanta/secureChat/secure-chat-system/client/src/components/ChatWindow.jsx`**
   - 移除独立的 WebSocket 连接代码
   - 使用 `useWebSocket` Hook 获取共享的 WebSocket
   - 使用 `addMessageHandler` 注册消息处理器
   - 添加 `isKeyReady` 状态追踪密钥就绪状态
   - 改进密钥发送重试机制
   - 更新 UI 状态显示（🔐 安全连接 / 🔄 密钥初始化中...）
   - 改进发送按钮的禁用逻辑

4. **`/home/lyanta/secureChat/secure-chat-system/client/src/components/UserList.jsx`**
   - 移除独立的 WebSocket 连接代码
   - 使用 `useWebSocket` Hook 获取共享的 WebSocket
   - 使用 `addMessageHandler` 注册消息处理器
   - 简化在线状态更新逻辑

### 文档文件

5. **`/home/lyanta/secureChat/密钥初始化问题修复说明.md`**
   - 详细的问题分析
   - 修复方案说明
   - 测试步骤
   - 关键改进点

6. **`/home/lyanta/secureChat/修复文件清单.md`**（本文件）
   - 修改文件列表
   - 修改内容概述

## 核心修复逻辑

### 问题根源
- **多个 WebSocket 连接**：UserList 和 ChatWindow 各自创建 WebSocket，导致同一用户的连接被覆盖
- **消息路由错误**：密钥交换消息可能发送到错误的 WebSocket 连接
- **时序竞争**：WebSocket 连接和密钥初始化的时序不确定性

### 解决方案
1. **全局单一 WebSocket**：使用 React Context 提供唯一的 WebSocket 连接
2. **消息分发机制**：通过消息处理器模式，让多个组件共享同一连接
3. **状态追踪**：添加密钥就绪状态，改善用户反馈
4. **重试机制**：WebSocket 未就绪时自动重试发送密钥

## 测试验证

### 测试场景
1. 正常窗口注册 google1
2. 隐私窗口注册 google2
3. 两个账号互相发送消息

### 预期结果
- ✅ WebSocket 连接成功（控制台显示 "全局WebSocket已连接"）
- ✅ 密钥交换成功（控制台显示密钥发送和接收日志）
- ✅ UI 显示 "🔐 安全连接"
- ✅ 消息可以正常加密发送和解密接收
- ✅ 历史消息正确解密显示

### 调试信息
打开浏览器控制台（F12），应该看到以下日志序列：
```
全局WebSocket已连接
已生成新的AES密钥
已发送加密的AES密钥        # 发送方
已接收并保存AES密钥        # 接收方
```

## 架构改进

### 修复前
```
App
├── UserList (有独立 WebSocket)
└── ChatWindow (有独立 WebSocket)
    └── 密钥交换失败：消息发送到错误的连接
```

### 修复后
```
App
└── WebSocketProvider (唯一 WebSocket)
    ├── UserList (注册消息处理器)
    └── ChatWindow (注册消息处理器)
        └── 密钥交换成功：所有消息正确路由
```

## 运行说明

### 启动服务器
```bash
cd /home/lyanta/secureChat/secure-chat-system/server
node server.js
```

### 启动客户端
```bash
cd /home/lyanta/secureChat/secure-chat-system/client
npm start
```

### 清理浏览器缓存（如果需要）
如果之前有测试数据，建议清理 localStorage：
1. 打开开发者工具（F12）
2. Application → Local Storage
3. 删除所有存储的密钥和令牌
4. 刷新页面

